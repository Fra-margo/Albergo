@{
    ViewBag.Title = "AddPrenotazione";
}

@using (Html.BeginForm("AddPrenotazione", "Prenotazione", FormMethod.Post))
{
    @Html.AntiForgeryToken()
<div class="m-3">
    <h3 class="mb-4">Inserisci nuova prenotazione:</h3>
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    <div class="form-group">
        <label>Cliente:</label>
        <select name="IdCliente">
            <option value="">Seleziona un cliente</option>
            @foreach (var cliente in ViewBag.Cliente)
            {
                <option value="@cliente.IdCliente">
                    @cliente.CodiceFiscale
                </option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Data Prenotazione:</label>
        <input name="DataPrenotazione" type="date" class="form-control" />
    </div>
    <div class="form-group">
        <label>Anno</label>
        <input name="Anno" type="number" class="form-control" min="@DateTime.Now.Year" />
    </div>
    <div class="form-group">
        <label>Data Arrivo:</label>
        <input id="DataArrivo" name="DataArrivo" type="date" class="form-control" />
    </div>
    <div class="form-group">
        <label>Data Partenza:</label>
        <input id="DataPartenza" name="DataPartenza" type="date" class="form-control" />
    </div>
    <div class="form-group">
        <label>Caparra confirmatoria:</label>
        <input id="CaparraConfirmatoria" name="CaparraConfirmatoria" type="number" class="form-control" />
    </div>
    <div class="form-group">
        <label>Tariffa Applicata (Tassa):</label>
        <input id="TariffaApplicata" name="TariffaApplicata" type="number" class="form-control" />
    </div>
    <div class="form-group">
        <label>Scegli la camera</label>
        <select id="IdCamera" name="IdCamera">
            @foreach (var item in ViewBag.Camera)
            {
                var prezzo = item.Prezzo.ToString("0.00");
                <option value="@item.IdCamera" data-prezzo="@prezzo">
                    N° @item.NumeroCamera / @prezzo €
                </option>
            }
        </select>
    </div>
    <div class="form-group">
        <label>Tipo Soggiorno:</label>
        <select id="TipoSoggiorno" name="TipoSoggiorno">
            <option value="Mezza Pensione">Mezza Pensione +50€</option>
            <option value="Pensione Completa">Pensione Completa +100€</option>
            <option value="Pernottamento Colazione">Pernottamento con prima colazione +150€</option>
        </select>
    </div>
    <div class="form-group">
        <label>Totale da Pagare:</label>
        <input id="totaleDaPagare" name="TotaleDaPagare" type="number" class="form-control" readonly />

    </div>
    <div id="erroreClienteNonSelezionato" style="display: none; color: red;">
        Seleziona un cliente prima di inviare il modulo.
    </div>
    <button class="mt-3">Inserisci Prenotazione</button>
</div>
}

@section scripts{
    <script>
        $(function () {
            function calcolaTotale() {
                var tariffaApplicata = parseFloat($('#TariffaApplicata').val()) || 0;
                var prezzoCamera = parseFloat($('#IdCamera option:selected').data('prezzo')) || 0;
                var caparraConfirmatoria = parseFloat($('#CaparraConfirmatoria').val()) || 0;
                var tipoSoggiorno = $('#TipoSoggiorno').val();
                var dataArrivo = new Date($('#DataArrivo').val());
                var dataPartenza = new Date($('#DataPartenza').val());

                var differenzaGiorni = Math.ceil((dataPartenza - dataArrivo) / (1000 * 60 * 60 * 24));
                var prezzoSoggiorno = 0;

                switch (tipoSoggiorno) {
                    case 'Mezza Pensione':
                        prezzoSoggiorno = 50;
                        break;
                    case 'Pensione Completa':
                        prezzoSoggiorno = 100;
                        break;
                    case 'Pernottamento Colazione':
                        prezzoSoggiorno = 150;
                        break;
                    default:
                        prezzoSoggiorno = 0;
                        break;
                }

                var totaleDaPagare = (tariffaApplicata + prezzoCamera - caparraConfirmatoria + prezzoSoggiorno) * differenzaGiorni;

                $('#totaleDaPagare').val(totaleDaPagare);
            }

            $('#TariffaApplicata, #IdCamera, #CaparraConfirmatoria, #TipoSoggiorno, #DataArrivo, #DataPartenza').change(function () {
                calcolaTotale();
            });

            $('#TipoSoggiorno').change(function () {
                calcolaTotale();
            });
        });

        $(function () {
            $('form').submit(function (event) {
                var idCliente = $('select[name="IdCliente"]').val();
                if (idCliente === "") {

                    event.preventDefault();
                    $('#erroreClienteNonSelezionato').show();
                }
            });
        });
    </script>
}
